generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  username    String
  password    String
  accountType String   @default("LEARNER") @map("account_type")
  Learner     Learner?

  @@unique([username])
  @@map("users")
}

model Learner {
  id   Int  @id
  User User @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  SequenceCourse   SequenceCourse? @relation(fields: [typeLearnerId, sequenceCourseId], references: [typeLearnerId, courseId])
  typeLearnerId    Int?            @map("type_learner_id")
  sequenceCourseId Int?            @map("sequence_course_id")

  latestCourseInSequenceCourses Course? @relation(fields: [latestCourseId], references: [id])
  latestCourseId                Int?    @map("latest_course_id")

  RegisterCourses      RegisterCourse[]
  HistoryStudiedCourse HistoryStudiedCourse[]

  @@map("learners")
}

model TypeLearner {
  id             Int              @id @default(autoincrement())
  name           String
  SequenceCourse SequenceCourse[]
  startScore     Float            @map("start_score")

  @@unique([name])
  @@map("type_learners")
}

model Course {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @map("updated_at")
  name        String
  description String
  labels      String[]

  SequenceCourse SequenceCourse[]
  Learner        Learner[]
  Topic          Topic[]
  RegisterCourse RegisterCourse[]

  @@map("courses")
}

model Topic {
  id       Int    @id @default(autoincrement())
  Course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  courseId Int    @map("course_id")
  name     String
  order    Int

  Lessons Lesson[]

  @@unique([courseId, name])
  @@map("topics")
}

model Lesson {
  id        Int      @id @default(autoincrement())
  title     String
  order     Int
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  LearningMaterial   LearningMaterial? @relation(fields: [learningMaterialId], references: [id])
  learningMaterialId Int?              @map("learning_material_id")

  Topic                Topic                  @relation(fields: [topicId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  topicId              Int                    @map("topic_id")
  HistoryStudiedCourse HistoryStudiedCourse[]

  @@unique([topicId, title])
  @@map("lessons")
}

model LearningMaterial {
  id        Int                  @id @default(autoincrement())
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @default(now()) @map("updated_at")
  filepath  String?
  mimetype  String?
  type      LearningMaterialType

  Lesson Lesson[]
  Quiz   Quiz[]

  @@map("learning_materials")
}

model Quiz {
  id               Int
  LearningMaterial LearningMaterial @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  index         Int      @default(0)
  question      String
  answers       String[]
  correctAnswer Int      @map("correct_answer")

  @@unique([id, index])
  @@map("quizes")
}

model RegisterCourse {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  Learner   Learner? @relation(fields: [learnerId], references: [id], onUpdate: Cascade)
  learnerId Int?     @map("learner_id")

  Course   Course? @relation(fields: [courseId], references: [id], onUpdate: Cascade)
  courseId Int?    @map("course_id")

  @@unique([learnerId, courseId])
  @@map("register_courses")
}

model HistoryStudiedCourse {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at")

  Learner   Learner @relation(fields: [learnerId], references: [id])
  learnerId Int     @map("learner_id")

  Lesson        Lesson @relation(fields: [lessonTopicId, lessonTitle], references: [topicId, title])
  lessonTopicId Int
  lessonTitle   String

  @@unique([lessonTopicId, lessonTitle, learnerId])
  @@map("history_studied_course")
}

model SequenceCourse {
  id            Int         @id @default(autoincrement())
  createdAt     DateTime    @default(now()) @map("created_at")
  TypeLearner   TypeLearner @relation(fields: [typeLearnerId], references: [id])
  typeLearnerId Int         @map("type_learner_id")

  Course   Course @relation(fields: [courseId], references: [id])
  courseId Int    @map("course_id")

  Learner Learner[]

  @@unique([typeLearnerId, courseId])
  @@map("sequence_courses")
}

model IntroQuestion {
  id        Int      @id @default(autoincrement())
  question  String
  answers   String[]
  scores    Int[]

  @@map("intro_questions")
}

enum LearningMaterialType {
  PDF
  QUIZ
  VIDEO
}

enum AccountType {
  ADMIN
  LEARNER
}

enum GenderType {
  MALE
  FEMALE
  UNKNOWN
}